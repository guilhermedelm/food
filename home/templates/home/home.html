<!DOCTYPE html>p
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Mercados Locais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS + JS -->
    <!-- Leaflet CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.6/css/star-rating.min.css" rel="stylesheet">

    <!-- JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-star-rating/4.0.6/js/star-rating.min.js"></script>

    

</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Encontrar Mercados Próximos</h1>
    
        <form method="POST" class="card p-4 shadow-sm">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">Latitude:</label>
                <input type="text" name="latitude" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Longitude:</label>
                <input type="text" name="longitude" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Max Distance (km):</label>
                <input type="number" name="max_distance" class="form-control" value="20" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Food Type:</label>
                <input type="text" name="food_type" class="form-control" >
            </div>
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>
        
        {% if error %}
            <div class="alert alert-danger mt-4">{{ error }}</div>
        {% endif %}
    
        {% if markets %}
            <div id="map" style="height: 500px; margin-top: 20px;"></div>

            <div id="market-info" class="mt-4 card p-3 shadow-sm" style="display: none;">
                <h5 id="info-name" class="mb-2"></h5>
                <p><strong>Endereço:</strong> <span id="info-address"></span></p>
                <p><strong>Distância:</strong> <span id="info-distance"></span> km</p>
                <p><strong>Produtos:</strong> <span id="info-products"></span></p>
                <p><strong>Pontuação:</strong> <span id="info-score"></span></p>
            </div>
            

            <form method="POST" class="card p-4 shadow-sm mt-4">
                {% csrf_token %}
                <input type="hidden" name="listing_name" value="{{ markets.0.0 }}"> <!-- Assume o primeiro mercado listado -->
                <div class="mb-3">
                    <label class="form-label">Sua nota para o local:</label>
                    <input id="rating" name="user_rating" type="number" class="rating" min="0" max="5" step="0.5" data-size="md">
                </div>
                <button type="submit" class="btn btn-success">Enviar Nota</button>
            </form>


            <h2 class="mt-5">Mercados próximos:</h2>
            <table class="table table-striped table-bordered mt-3">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Endereço</th>
                        <th>Distância (km)</th>
                        <th>Produtos</th>
                        <th>Nota</th>
                    </tr>
                </thead>
                <tbody>
                    {% for market in markets %}
                    <tr>
                        <td>{{ market.0 }}</td>
                        <td>{{ market.1 }}</td>
                        <td>{{ market.2|floatformat:2 }}</td>
                        <td>{{ market.3}}</td>
                        <td>{{ market.6}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <script>
                const userLat = parseFloat('{{ latitude|default:"0" }}')
                const userLng = parseFloat('{{ longitude|default:"0" }}')

                const markets = JSON.parse(`{{ markets_json|escapejs }}`);

                const map = L.map('map').setView([userLat, userLng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                L.marker([userLat, userLng]).addTo(map)
                    .bindPopup('Sua Localização')
                    .openPopup();

                for (const market of markets) {
                    const [name, address, distance, products, lat, lng, score] = market;

                    const marker = L.marker([lat, lng]).addTo(map)
                        .bindPopup(`<strong>${name}</strong><br>${address}<br><em>${products}</em><br>${distance.toFixed(2)} km`);

                    marker.on('click', () => {
                        document.getElementById("info-name").textContent = name;
                        document.getElementById("info-address").textContent = address;
                        document.getElementById("info-distance").textContent = distance.toFixed(2);
                        document.getElementById("info-products").textContent = products;
                        document.getElementById("info-score").textContent = score;

                        document.getElementById("market-info").style.display = "block";
                        document.getElementById("market-info").scrollIntoView({ behavior: "smooth" });
                    });
                }
            </script>


        {% endif %}
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    

</body>
</html>
